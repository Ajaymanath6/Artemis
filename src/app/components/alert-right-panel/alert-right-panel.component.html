<!-- Alert Panel Container: Header (Fixed) ‚Üí Body (Scrollable) ‚Üí Footer (Absolute, Always Visible) -->
<div class="alert-panel-container w-full bg-white flex flex-col flex-shrink-0 overflow-hidden relative" 
     [class]="isStatic ? 'static w-96 flex-shrink-0 overflow-hidden' : ''">
  
  <!-- HEADER: Fixed at top (53px) -->
  <div class="panel-header border-b border-gray-200 bg-gray-100 flex items-center justify-between flex-shrink-0 p-4" style="height: 53px;">
    <div class="flex items-center gap-2">
      <!-- Back Button (only show when in case detail view) -->
    <button 
        *ngIf="showCaseDetail"
        (click)="onBackFromCaseDetail()" 
        class="bg-transparent border-none cursor-pointer p-1 rounded-md text-gray-500 transition-all duration-200 hover:bg-gray-100 hover:text-gray-700"
        title="Back to alerts">
        <i class="ri-arrow-left-line text-sm"></i>
    </button>
      <h2 class="text-sm font-semibold text-gray-900" style="margin: 0; padding: 0;">
        {{ showCaseDetail ? 'Case Details' : (selectedAlert ? 'Edit Alert' : 'Create Alert') }}
      </h2>
    </div>
    
    <!-- Collapse Button (only show when panel is expanded) -->
    <button 
        *ngIf="isRightPanelExpanded"
        (click)="onCollapsePanel()" 
        class="bg-transparent border-none cursor-pointer p-1 rounded-md text-gray-500 transition-all duration-200 hover:bg-gray-100 hover:text-gray-700"
        title="Collapse panel">
        <i class="ri-layout-right-line text-lg"></i>
    </button>
  </div>

  <!-- BODY: Scrollable content area (flex: 1) -->
  <div class="panel-content flex-1 overflow-y-auto p-4">
    
    <!-- DEBUG STATE PANEL (Remove after fixing) -->
    <div class="mb-4 p-3 bg-yellow-50 border-2 border-yellow-300 rounded-lg text-xs font-mono">
      <div class="font-bold text-yellow-800 mb-2">üêõ DEBUG STATE:</div>
      <div class="space-y-1 text-gray-700">
        <div>showCaseDetail: <span class="font-bold" [class.text-red-600]="showCaseDetail" [class.text-green-600]="!showCaseDetail">{{ showCaseDetail }}</span></div>
        <div>showAlertCases: <span class="font-bold" [class.text-red-600]="showAlertCases" [class.text-green-600]="!showAlertCases">{{ showAlertCases }}</span></div>
        <div>selectedAlert: <span class="font-bold">{{ selectedAlert?.name || 'null' }}</span></div>
        <div>selectedCase: <span class="font-bold">{{ selectedCase?.title || 'null' }}</span></div>
        <div class="mt-2 pt-2 border-t border-yellow-300">
          <div class="font-bold text-yellow-800">Active View:</div>
          <div *ngIf="showCaseDetail && selectedCase" class="text-blue-600 font-bold">‚Üí Case Detail View</div>
          <div *ngIf="selectedAlert && !showCaseDetail && showAlertCases" class="text-blue-600 font-bold">‚Üí Alert Cases View</div>
          <div *ngIf="!showCaseDetail && !(selectedAlert && showAlertCases)" class="text-green-600 font-bold">‚Üí Alert Form View ‚úì (FALLBACK)</div>
          <div *ngIf="!showCaseDetail && !(selectedAlert && showAlertCases) && !selectedAlert" class="text-purple-600 font-bold">(Create New Alert)</div>
        </div>
      </div>
    </div>
    
    <!-- Case Detail View -->
    <div *ngIf="showCaseDetail && selectedCase" class="case-detail-view">
      <!-- Case Title -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-[#146B85] mb-2">{{ selectedCase.title }}</h3>
        <div class="flex items-center gap-2 mb-4">
          <span *ngIf="selectedCase.badge" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" 
                style="background-color: #E5E7EB; color: #374151;">
            {{ selectedCase.badge }}
          </span>
        </div>
      </div>
      
      <!-- Case Details Grid -->
      <div class="space-y-4 mb-6">
        <div class="grid grid-cols-1 gap-4">
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="text-xs font-semibold text-gray-500 mb-1">CASE ID</div>
            <div class="text-sm font-medium text-gray-900">{{ selectedCase.caseId }}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="text-xs font-semibold text-gray-500 mb-1">COURT</div>
            <div class="text-sm font-medium text-gray-900">{{ selectedCase.court }}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="text-xs font-semibold text-gray-500 mb-1">DATE</div>
            <div class="text-sm font-medium text-gray-900">{{ selectedCase.date }}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="text-xs font-semibold text-gray-500 mb-1">TYPE</div>
            <div class="text-sm font-medium text-gray-900">{{ selectedCase.type }}</div>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="text-xs font-semibold text-gray-500 mb-1">STATUS</div>
            <div class="text-sm font-medium text-gray-900">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" 
                    style="background-color: #E5E7EB; color: #374151;">
                {{ selectedCase.status }}
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Case Description -->
      <div class="mb-6">
        <div class="text-xs font-semibold text-gray-500 mb-2">CASE DESCRIPTION</div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-sm text-gray-700 leading-relaxed">
            This case involves complex legal proceedings related to {{ selectedCase.type.toLowerCase() }} matters. 
            The case is currently in {{ selectedCase.status.toLowerCase() }} status and is being handled by {{ selectedCase.court }}.
            Key developments and documentation are being tracked as the case progresses through the judicial system.
          </p>
        </div>
      </div>
      
      <!-- Recent Activity -->
      <div class="mb-6">
        <div class="text-xs font-semibold text-gray-500 mb-2">RECENT ACTIVITY</div>
        <div class="space-y-3">
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="flex items-start gap-3">
              <i class="ri-file-text-line text-[#146B85] text-sm mt-0.5"></i>
              <div class="flex-1">
                <div class="text-sm font-medium text-gray-900">New document filed</div>
                <div class="text-xs text-gray-600">Motion for summary judgment submitted</div>
                <div class="text-xs text-gray-500 mt-1">{{ selectedCase.lastUpdated }}</div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="flex items-start gap-3">
              <i class="ri-calendar-line text-[#146B85] text-sm mt-0.5"></i>
              <div class="flex-1">
                <div class="text-sm font-medium text-gray-900">Hearing scheduled</div>
                <div class="text-xs text-gray-600">Next court appearance set for review</div>
                <div class="text-xs text-gray-500 mt-1">3 days ago</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Alert Cases View (when viewing cases for an alert) -->
    <div *ngIf="selectedAlert && !showCaseDetail && showAlertCases" class="alert-cases-view relative">
      
      <!-- Loading Overlay -->
      <div *ngIf="isLoadingCases" class="alert-cases-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Fetching cases for your alert</div>
      </div>
      
      <!-- Content (hidden when loading) -->
      <div *ngIf="!isLoadingCases">
        <!-- Alert Header -->
        <div class="mb-4 flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">{{ getHeaderTitle() }}</h3>
            <p class="text-sm text-gray-600 mt-1">{{ getHeaderSubtitle() }}</p>
          </div>
          <!-- Expand/Collapse Toggle Icon -->
          <button 
            class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
            (click)="onExpandCases()"
            [title]="isRightPanelExpanded ? 'Collapse panel' : 'Expand to see all cases'">
            <i [class]="isRightPanelExpanded ? 'ri-compress-line text-lg' : 'ri-expand-diagonal-line text-lg'"></i>
          </button>
        </div>
        
        <!-- Divider -->
        <div class="border-t border-gray-200 mb-4"></div>
        
        <!-- Cases List (Result Cards Alert - No tooltips or hover icons) -->
        <div class="space-y-0">
          <app-result-card-alert 
            *ngFor="let case of caseData" 
            [caseData]="case"
            (cardClick)="onCaseClick($event)"
            (markAsRead)="onCaseMarkAsRead($event)">
          </app-result-card-alert>
        </div>
      </div>
    </div>

    <!-- Alert Form View (DEFAULT/FALLBACK - always show unless explicitly showing case detail or alert cases) -->
    <div *ngIf="!showCaseDetail && !(selectedAlert && showAlertCases)">
        <!-- New Alert Title -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-gray-900">{{ getHeaderTitle() }}</h3>
          <p class="text-sm text-gray-600 mt-1">{{ getHeaderSubtitle() }}</p>
        </div>
        
        <!-- Divider -->
        <div class="border-t border-gray-200 mb-4"></div>
    
    <!-- Instant Email Alert Toggle -->
    <div class="form-section flex items-center justify-between p-3 bg-gray-50 rounded-lg">
      <div class="flex items-center gap-2">
        <span class="text-sm font-medium text-gray-900">Instant email alert</span>
        <i class="ri-information-line text-gray-500 cursor-help" title="Get notified immediately when new cases match your criteria"></i>
      </div>
      <button 
        class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#146B85] focus:ring-offset-2"
        [class]="instantEmailEnabled ? 'bg-[#146B85]' : 'bg-gray-300'"
        (click)="toggleInstantEmail()">
        <span class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
              [class]="instantEmailEnabled ? 'translate-x-5' : 'translate-x-1'"></span>
      </button>
    </div>
    
    <!-- Case Alert Criteria Section -->
    <div class="form-section">
      <label class="block text-xs font-semibold text-gray-700 mb-2">Case Alert Criteria</label>
      <textarea 
        [(ngModel)]="alertData.researchQuestion"
        placeholder="Enter keywords, case types, or criteria to monitor..."
        rows="3"
        class="w-full p-3 border border-gray-300 rounded-lg text-sm text-gray-900 transition-colors focus:outline-none focus:border-[#146B85] focus:ring-3 focus:ring-[#146B85]/10 resize-vertical min-h-[4rem] box-border"
        (input)="onResearchQuestionChange()">
      </textarea>
    </div>
    
    <!-- When to receive alerts -->
    <div class="form-section">
      <label class="block text-xs font-semibold text-gray-700 mb-3">When do you want to receive the alerts?</label>
      <div class="space-y-3">
        <!-- Daily Summary Option -->
        <div 
          class="timing-option-card p-4 border-2 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50"
          [class]="alertData.timing === 'daily' ? 'border-[#146B85] bg-[#146B85] bg-opacity-5' : 'border-gray-200'"
          (click)="selectTiming('daily')">
          <div class="flex items-start gap-3">
            <div class="mt-0.5">
              <div class="w-4 h-4 rounded-full border flex items-center justify-center transition-colors"
                   [class.border-[#146B85]]="alertData.timing === 'daily'"
                   [class.border-gray-300]="alertData.timing !== 'daily'"
                   [class.bg-[#146B85]]="alertData.timing === 'daily'"
                   [class.bg-opacity-20]="alertData.timing === 'daily'">
                <div *ngIf="alertData.timing === 'daily'" class="w-1.5 h-1.5 bg-[#146B85] rounded-full"></div>
              </div>
            </div>
            <div class="flex-1">
              <div class="text-sm font-medium text-gray-900">Daily Summary</div>
              <p class="text-xs text-gray-600 mt-1">An email is sent daily to the recipients of the alert.</p>
            </div>
          </div>
        </div>
        
        <!-- Immediately Option -->
        <div 
          class="timing-option-card p-4 border-2 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50"
          [class]="alertData.timing === 'immediate' ? 'border-[#146B85] bg-[#146B85] bg-opacity-5' : 'border-gray-200'"
          (click)="selectTiming('immediate')">
          <div class="flex items-start gap-3">
            <div class="mt-0.5">
              <div class="w-4 h-4 rounded-full border flex items-center justify-center transition-colors"
                   [class.border-[#146B85]]="alertData.timing === 'immediate'"
                   [class.border-gray-300]="alertData.timing !== 'immediate'"
                   [class.bg-[#146B85]]="alertData.timing === 'immediate'"
                   [class.bg-opacity-20]="alertData.timing === 'immediate'">
                <div *ngIf="alertData.timing === 'immediate'" class="w-1.5 h-1.5 bg-[#146B85] rounded-full"></div>
              </div>
            </div>
            <div class="flex-1">
              <div class="text-sm font-medium text-gray-900">Immediately when found</div>
              <p class="text-xs text-gray-600 mt-1">We will let you know the moment we find a match.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Who should receive alerts -->
    <div class="form-section">
      <label class="block text-xs font-semibold text-gray-700 mb-3">Who should receive the alerts?</label>
      <div class="space-y-3">
        <!-- Everyone on project -->
        <div 
          class="recipient-option-card p-4 border-2 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50"
          [class]="alertData.recipients === 'everyone' ? 'border-[#146B85] bg-[#146B85] bg-opacity-5' : 'border-gray-200'"
          (click)="selectRecipients('everyone')">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded-full border flex items-center justify-center transition-colors"
                 [class.border-[#146B85]]="alertData.recipients === 'everyone'"
                 [class.border-gray-300]="alertData.recipients !== 'everyone'"
                 [class.bg-[#146B85]]="alertData.recipients === 'everyone'"
                 [class.bg-opacity-20]="alertData.recipients === 'everyone'">
              <div *ngIf="alertData.recipients === 'everyone'" class="w-1.5 h-1.5 bg-[#146B85] rounded-full"></div>
            </div>
            <div class="text-sm font-medium text-gray-900">Everyone on the project</div>
          </div>
        </div>
        
        <!-- Pick recipients -->
        <div 
          class="recipient-option-card p-4 border-2 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50"
          [class]="alertData.recipients === 'selected' ? 'border-[#146B85] bg-[#146B85] bg-opacity-5' : 'border-gray-200'"
          (click)="selectRecipients('selected')">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded-full border flex items-center justify-center transition-colors"
                 [class.border-[#146B85]]="alertData.recipients === 'selected'"
                 [class.border-gray-300]="alertData.recipients !== 'selected'"
                 [class.bg-[#146B85]]="alertData.recipients === 'selected'"
                 [class.bg-opacity-20]="alertData.recipients === 'selected'">
              <div *ngIf="alertData.recipients === 'selected'" class="w-1.5 h-1.5 bg-[#146B85] rounded-full"></div>
            </div>
            <div class="text-sm font-medium text-gray-900">Pick who should receive them...</div>
          </div>
        </div>
        
        <!-- User Selection Area (only show when "selected" is chosen) -->
        <div *ngIf="alertData.recipients === 'selected'" class="ml-7 mt-4 space-y-3">
          <div class="text-xs font-semibold text-gray-500 mb-3">ONLY SEND TO...</div>
          
          <!-- User 1: Alexander Kelly -->
          <div class="user-card flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
            <input 
              type="checkbox" 
              id="alexander"
              [(ngModel)]="alertData.selectedUsers.alexander"
              class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300 rounded">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                AK
              </div>
              <div>
                <div class="text-sm font-medium text-gray-900">Alexander Kelly</div>
                <div class="text-xs text-gray-500">alex.kelly&#64;company.com</div>
              </div>
            </div>
          </div>
          
          <!-- User 2: Sarah Johnson -->
          <div class="user-card flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
            <input 
              type="checkbox" 
              id="sarah"
              [(ngModel)]="alertData.selectedUsers.sarah"
              class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300 rounded">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                SJ
              </div>
              <div>
                <div class="text-sm font-medium text-gray-900">Sarah Johnson</div>
                <div class="text-xs text-gray-500">sarah.johnson&#64;company.com</div>
              </div>
            </div>
          </div>
          
          <!-- User 3: Michael Davis -->
          <div class="user-card flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
            <input 
              type="checkbox" 
              id="michael"
              [(ngModel)]="alertData.selectedUsers.michael"
              class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300 rounded">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                MD
              </div>
              <div>
                <div class="text-sm font-medium text-gray-900">Michael Davis</div>
                <div class="text-xs text-gray-500">michael.davis&#64;company.com</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Additional Settings Section -->
    <div class="form-section">
      <label class="block text-xs font-semibold text-gray-700 mb-3">Additional Settings</label>
      <div class="space-y-3">
        <!-- Case Priority Filter -->
        <div class="p-3 bg-gray-50 rounded-lg">
          <label class="block text-sm font-medium text-gray-900 mb-2">Priority Level</label>
          <select [(ngModel)]="alertData.priority" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
            <option value="all">All Priorities</option>
            <option value="high">High Priority Only</option>
            <option value="medium">Medium Priority</option>
            <option value="low">Low Priority</option>
          </select>
        </div>
        
        <!-- Date Range Filter -->
        <div class="p-3 bg-gray-50 rounded-lg">
          <label class="block text-sm font-medium text-gray-900 mb-2">Date Range</label>
          <div class="grid grid-cols-2 gap-2">
            <input type="date" [(ngModel)]="alertData.dateFrom" class="p-2 border border-gray-300 rounded-lg text-sm">
            <input type="date" [(ngModel)]="alertData.dateTo" class="p-2 border border-gray-300 rounded-lg text-sm">
          </div>
        </div>
        
        <!-- Case Type Filter -->
        <div class="p-3 bg-gray-50 rounded-lg">
          <label class="block text-sm font-medium text-gray-900 mb-2">Case Types</label>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="civil" [(ngModel)]="alertData.caseTypes.civil" class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300 rounded">
              <label for="civil" class="text-sm text-gray-700">Civil Cases</label>
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="criminal" [(ngModel)]="alertData.caseTypes.criminal" class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300 rounded">
              <label for="criminal" class="text-sm text-gray-700">Criminal Cases</label>
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="family" [(ngModel)]="alertData.caseTypes.family" class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300 rounded">
              <label for="family" class="text-sm text-gray-700">Family Law</label>
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="corporate" [(ngModel)]="alertData.caseTypes.corporate" class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300 rounded">
              <label for="corporate" class="text-sm text-gray-700">Corporate Law</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Alert Preferences Section -->
    <div class="form-section">
      <label class="block text-xs font-semibold text-gray-700 mb-3">Alert Preferences</label>
      <div class="space-y-3">
        <!-- Alert Format -->
        <div class="p-3 bg-gray-50 rounded-lg">
          <label class="block text-sm font-medium text-gray-900 mb-2">Alert Format</label>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <input type="radio" id="summary" name="alertFormat" value="summary" [(ngModel)]="alertData.format" class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300">
              <label for="summary" class="text-sm text-gray-700">Brief Summary</label>
            </div>
            <div class="flex items-center gap-2">
              <input type="radio" id="detailed" name="alertFormat" value="detailed" [(ngModel)]="alertData.format" class="h-4 w-4 text-[#146B85] focus:ring-[#146B85] border-gray-300">
              <label for="detailed" class="text-sm text-gray-700">Detailed Report</label>
            </div>
          </div>
        </div>
        
        <!-- Include Attachments -->
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-900">Include Attachments</span>
            <i class="ri-information-line text-gray-500 cursor-help" title="Include case documents and files in the alert"></i>
          </div>
          <button 
            class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#146B85] focus:ring-offset-2"
            [class]="alertData.includeAttachments ? 'bg-[#146B85]' : 'bg-gray-300'"
            (click)="toggleAttachments()">
            <span class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                  [class]="alertData.includeAttachments ? 'translate-x-5' : 'translate-x-1'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER: Absolutely positioned at bottom, ALWAYS visible (never scrolls) -->  
  <div class="panel-footer">
    <button 
      (click)="onCancel()" 
      class="flex-1 px-6 py-3 bg-white text-gray-700 border border-gray-300 rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-gray-50 hover:border-gray-400 mr-2">
      {{ (showCaseDetail || showAlertCases) ? 'Close' : 'Cancel' }}
    </button>
    <button 
      (click)="onSave()" 
      class="flex-1 px-6 py-3 bg-[#146B85] text-white border border-[#146B85] rounded-lg text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-[#0f5462] hover:border-[#0f5462] disabled:bg-gray-400 disabled:border-gray-400 disabled:cursor-not-allowed disabled:opacity-60"
      [disabled]="!isFormValid()"
      *ngIf="!showCaseDetail && !showAlertCases">
      Apply
    </button>
  </div>

</div>